<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Mission Control v5</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; min-height: 100vh; overflow-x: hidden; }

:root {
  --bg: #000000;
  --surface: #0d0d0d;
  --surface2: #141414;
  --border: #1a1a1a;
  --border2: #242424;
  --text: #f0f0f0;
  --text2: #888;
  --dim: #555;
  --accent: #00D9FF;
  --green: #39FF14;
  --gold: #FFD700;
  --red: #FF3B3B;
  --orange: #FF8C00;
  --purple: #a78bfa;
  --pink: #f472b6;
}

body {
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 18px;
  line-height: 1.5;
}

/* ─── HEADER ──────────────────────────────────────────── */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  width: 100vw;
  background: rgba(0,0,0,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border2);
  padding: 12px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.wjp-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--border2);
}

.header-logo {
  font-size: 23px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--accent);
}

.header-logo span {
  color: var(--text2);
  font-weight: 400;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 16px;
  color: var(--text2);
}

.refresh-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--border2);
  border-radius: 999px;
  font-size: 14px;
  color: var(--text2);
  cursor: pointer;
  transition: border-color 0.2s;
}

.refresh-badge:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.refresh-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s infinite;
}

.refresh-dot.stale {
  background: var(--gold);
  animation: none;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ─── MAIN ────────────────────────────────────────────── */
.main {
  width: 100vw;
  max-width: 100vw;
  padding: 24px 32px;
  display: flex;
  flex-direction: column;
  gap: 28px;
  box-sizing: border-box;
}

/* ─── SECTION TITLE ───────────────────────────────────── */
.section-title {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text2);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.section-pfp {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--border2);
  flex-shrink: 0;
}

/* ─── CARD ────────────────────────────────────────────── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}

.card-body {
  padding: 16px;
}

/* ─── ERROR BANNER ────────────────────────────────────── */
#error-banner {
  background: rgba(255, 59, 59, 0.08);
  border: 1px solid rgba(255, 59, 59, 0.4);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  display: none;
}

#error-banner.visible { display: block; }

.error-title {
  font-size: 21px;
  font-weight: 700;
  color: var(--red);
  margin-bottom: 8px;
}

.error-url {
  font-family: monospace;
  font-size: 17px;
  color: var(--text2);
  background: var(--surface2);
  padding: 6px 12px;
  border-radius: 6px;
  margin: 8px 0;
  word-break: break-all;
}

.retry-btn {
  display: inline-block;
  margin-top: 12px;
  padding: 8px 20px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
}

/* ─── YOUR MOVE SECTION ───────────────────────────────── */
.your-move-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 8px;
}

@media (max-width: 640px) {
  .your-move-grid { grid-template-columns: 1fr; }
}

.move-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  border-left-width: 3px;
  transition: background 0.15s;
}

.move-item:hover { background: var(--surface2); }

.move-item.critical { border-left-color: var(--red); }
.move-item.high { border-left-color: var(--orange); }
.move-item.medium { border-left-color: var(--gold); }
.move-item.low { border-left-color: var(--text2); }

.move-urgency {
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 3px 8px;
  border-radius: 999px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 1px;
}

.urgency-critical { background: rgba(255,59,59,0.15); color: var(--red); }
.urgency-high { background: rgba(255,140,0,0.15); color: var(--orange); }
.urgency-medium { background: rgba(255,215,0,0.15); color: var(--gold); }
.urgency-low { background: rgba(136,136,136,0.15); color: var(--text2); }

.move-content {
  flex: 1;
  min-width: 0;
}

.move-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.move-ask {
  font-size: 17px;
  color: var(--text2);
  line-height: 1.4;
}

.move-project {
  font-size: 14px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--surface2);
  color: var(--text2);
  flex-shrink: 0;
  white-space: nowrap;
}

.all-clear {
  padding: 24px;
  text-align: center;
  color: var(--text2);
  font-size: 18px;
}

.all-clear .icon { font-size: 36px; margin-bottom: 8px; }
.all-clear .label { color: var(--green); font-weight: 600; }

/* ─── AGENTS SECTION ──────────────────────────────────── */
.agents-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
}

@media (max-width: 640px) {
  .agents-grid { grid-template-columns: 1fr; }
}

.agent-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}

.agent-card.rate-limited {
  border-color: rgba(255,59,59,0.4);
  background: rgba(255,59,59,0.03);
}

.agent-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.agent-identity {
  display: flex;
  align-items: center;
  gap: 10px;
}

.agent-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--border2);
  flex-shrink: 0;
}

.agent-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.status-pill {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 3px 10px;
  border-radius: 999px;
}

.status-active { background: rgba(57,255,20,0.12); color: var(--green); }
.status-online { background: rgba(0,217,255,0.12); color: var(--accent); }
.status-ssh-only { background: rgba(255,215,0,0.12); color: var(--gold); }
.status-offline { background: rgba(255,59,59,0.12); color: var(--red); }
.status-unknown { background: rgba(136,136,136,0.12); color: var(--text2); }

.agent-field {
  margin-bottom: 10px;
}

.field-label {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text2);
  margin-bottom: 4px;
}

.field-value {
  font-size: 17px;
  color: var(--text);
}

.field-value.muted { color: var(--text2); }

/* context fuel gauge */
.fuel-gauge {
  height: 6px;
  background: var(--surface2);
  border-radius: 999px;
  overflow: hidden;
  margin-top: 6px;
}

.fuel-fill {
  height: 100%;
  border-radius: 999px;
  transition: width 0.4s ease;
}

.fuel-green { background: var(--green); }
.fuel-yellow { background: var(--gold); }
.fuel-red { background: var(--red); }

.context-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.context-pct {
  font-size: 16px;
  font-weight: 700;
}

.context-pct.low { color: var(--green); }
.context-pct.mid { color: var(--gold); }
.context-pct.high { color: var(--red); }

.rate-limit-warning {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  padding: 6px 10px;
  background: rgba(255,59,59,0.08);
  border: 1px solid rgba(255,59,59,0.25);
  border-radius: 6px;
  font-size: 16px;
  color: var(--red);
  font-weight: 600;
}

/* ─── PROJECTS SECTION ────────────────────────────────── */
.projects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 12px;
}

@media (max-width: 768px) {
  .projects-grid { grid-template-columns: 1fr; }
}

.project-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  border-left-width: 3px;
  overflow: hidden;
}

.project-header {
  padding: 14px 16px 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.project-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.project-priority {
  font-size: 13px;
  color: var(--text2);
  font-weight: 600;
}

.project-status {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 3px 9px;
  border-radius: 999px;
}

.project-status.active { background: rgba(57,255,20,0.1); color: var(--green); }
.project-status.building { background: rgba(0,217,255,0.1); color: var(--accent); }
.project-status.paused { background: rgba(255,215,0,0.1); color: var(--gold); }
.project-status.blocked { background: rgba(255,59,59,0.1); color: var(--red); }
.project-status.queued { background: rgba(136,136,136,0.1); color: var(--text2); }

.project-desc {
  padding: 0 16px 12px;
  font-size: 16px;
  color: var(--text2);
  line-height: 1.4;
}

.project-divider {
  height: 1px;
  background: var(--border);
  margin: 0 16px;
}

.project-task {
  padding: 12px 16px;
}

.task-row {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 6px;
}

.task-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-top: 7px;
  flex-shrink: 0;
}

.dot-active { background: var(--green); }
.dot-blocked { background: var(--red); }
.dot-paused { background: var(--gold); }
.dot-queued { background: var(--text2); }

.task-text {
  font-size: 16px;
  color: var(--text2);
  line-height: 1.4;
}

.task-text strong {
  color: var(--text);
  font-weight: 600;
}

.next-action {
  padding: 8px 10px;
  background: var(--surface2);
  border-radius: 6px;
  font-size: 16px;
  color: var(--text2);
  border-left: 2px solid var(--border2);
}

.next-action::before {
  content: "→ ";
  color: var(--accent);
  font-weight: 600;
}

.project-needs {
  padding: 0 16px 12px;
}

.need-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 7px 0;
  border-top: 1px solid var(--border);
  font-size: 16px;
  line-height: 1.4;
}

.need-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 6px;
}

.need-dot.wjp-dot { background: var(--red); }
.need-dot.agent-dot { background: var(--accent); }

.need-text {
  color: var(--text2);
}

.need-text.wjp {
  color: var(--text);
}

.need-item.urgent .need-text { color: var(--red); }

/* ─── HEALTH FOOTER ───────────────────────────────────── */
.health-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
  width: 100vw;
  padding: 14px 32px;
  border-top: 1px solid var(--border);
  font-size: 16px;
  color: var(--text2);
}

.health-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.health-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

/* ─── LOADING ─────────────────────────────────────────── */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text2);
  font-size: 18px;
}

.loading::before {
  content: '';
  display: block;
  width: 24px;
  height: 24px;
  border: 2px solid var(--border2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ─── UTIL ────────────────────────────────────────────── */
.hidden { display: none !important; }

.tag {
  font-size: 14px;
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--surface2);
  color: var(--text2);
  font-weight: 500;
}

.intel-section {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.intel-item {
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 17px;
  color: var(--text2);
}

/* ─── MOBILE ──────────────────────────────────────────── */
@media (max-width: 480px) {
  .header { padding: 10px 14px; }
  .main { padding: 16px 12px; gap: 20px; }
  .move-title { white-space: normal; }
}
</style>
</head>
<body>

<!-- ══════════════════════ HEADER ══════════════════════════ -->
<header class="header">
  <div class="header-left">
    <div class="header-logo">Mission Control</div>
  </div>
  <div class="header-right">
    <div id="last-updated" style="font-size:14px;"></div>
    <div style="font-size:11px;color:var(--border2);user-select:none;">v4</div>
    <div class="refresh-badge" onclick="loadData()">
      <div class="refresh-dot" id="refresh-dot"></div>
      <span id="countdown">60s</span>
    </div>
  </div>
</header>

<!-- ══════════════════════ MAIN ════════════════════════════ -->
<main class="main" id="main">
  <div class="loading" id="loading">Loading mission data...</div>
</main>

<!-- ══════════════════════ HEALTH BAR ══════════════════════ -->
<div class="health-bar" id="health-bar" style="display:none;">
  <div class="health-item">
    <div class="health-dot" id="cron-dot" style="background:var(--text2);"></div>
    <span id="cron-status">Crons: —</span>
  </div>
  <div class="health-item">
    <span id="data-age">Data age: —</span>
  </div>
  <div class="health-item">
    <a href="./data.json" target="_blank" style="color:var(--text2);font-size:14px;text-decoration:none;">data.json ↗</a>
  </div>
</div>

<script>
// ════════════════════════════════════════════════════════
// CONFIG
// ════════════════════════════════════════════════════════
const DATA_URL = './data.json';
const REFRESH_INTERVAL = 60; // seconds

let countdown = REFRESH_INTERVAL;
let refreshTimer = null;
let countdownTimer = null;

// ════════════════════════════════════════════════════════
// FETCH
// ════════════════════════════════════════════════════════
async function loadData() {
  clearTimers();

  try {
    const res = await fetch(DATA_URL + '?t=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    render(data);
    startRefreshCycle();
  } catch (err) {
    showError(DATA_URL, err.message);
    refreshTimer = setTimeout(loadData, 30000);
  }
}

function clearTimers() {
  if (refreshTimer) clearTimeout(refreshTimer);
  if (countdownTimer) clearInterval(countdownTimer);
}

function startRefreshCycle() {
  countdown = REFRESH_INTERVAL;
  updateCountdown();
  countdownTimer = setInterval(() => {
    countdown--;
    updateCountdown();
    if (countdown <= 0) {
      clearInterval(countdownTimer);
      loadData();
    }
  }, 1000);
}

function updateCountdown() {
  const el = document.getElementById('countdown');
  if (el) el.textContent = countdown + 's';
}

// ════════════════════════════════════════════════════════
// RENDER
// ════════════════════════════════════════════════════════
function render(data) {
  const main = document.getElementById('main');
  main.innerHTML = '';

  // Last updated
  if (data.updatedAt) {
    const el = document.getElementById('last-updated');
    const d = new Date(data.updatedAt);
    const age = Math.floor((Date.now() - d.getTime()) / 60000);
    el.textContent = 'Updated ' + (age < 2 ? 'just now' : age + 'm ago');
    const dot = document.getElementById('refresh-dot');
    if (age > 180) {
      dot.classList.add('stale');
      el.style.color = 'var(--gold)';
    }

    const bar = document.getElementById('health-bar');
    bar.style.display = 'flex';
    document.getElementById('data-age').textContent = 'Data: ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }

  // Cron health
  if (data.health && data.health.crons) {
    const c = data.health.crons;
    const dot = document.getElementById('cron-dot');
    const label = document.getElementById('cron-status');
    if (c.errors > 0) {
      dot.style.background = 'var(--red)';
      label.textContent = 'Crons: ' + c.healthy + ' ok / ' + c.errors + ' errors';
    } else {
      dot.style.background = 'var(--green)';
      label.textContent = 'Crons: ' + c.healthy + ' healthy';
    }
  }

  // ── YOUR MOVE ──────────────────────────────────────────
  const needsWjp = (data.needsWjp || []).filter(n => n.urgency !== 'done');
  const urgencyOrder = { critical: 0, high: 1, medium: 2, low: 3 };
  needsWjp.sort((a, b) => (urgencyOrder[a.urgency] || 2) - (urgencyOrder[b.urgency] || 2));

  const yourMoveSection = document.createElement('section');
  yourMoveSection.innerHTML = '<div class="section-title"><img class="section-pfp" src="./wjp-pfp.png" alt="WJP">WJP</div>';
  const moveGrid = document.createElement('div');
  moveGrid.className = 'your-move-grid';

  if (needsWjp.length === 0) {
    moveGrid.innerHTML = `
      <div class="all-clear">
        <div class="icon">✓</div>
        <div class="label">All clear — no action required</div>
      </div>`;
  } else {
    needsWjp.forEach(item => {
      const div = document.createElement('div');
      div.className = 'move-item ' + (item.urgency || 'medium');
      div.innerHTML = `
        <span class="move-urgency urgency-${item.urgency || 'medium'}">${item.urgency || 'medium'}</span>
        <div class="move-content">
          <div class="move-title">${escHtml(item.title || item.ask || 'Action needed')}</div>
          ${item.ask ? '<div class="move-ask">' + escHtml(item.ask) + '</div>' : ''}
          ${item.impact ? '<div class="move-ask" style="margin-top:2px;color:var(--text2);">' + escHtml(item.impact) + '</div>' : ''}
        </div>
        ${item.project ? '<span class="move-project">' + escHtml(item.project) + '</span>' : ''}
      `;
      moveGrid.appendChild(div);
    });
  }

  yourMoveSection.appendChild(moveGrid);
  main.appendChild(yourMoveSection);

  // ── AGENTS ────────────────────────────────────────────
  if (data.agents) {
    const agentsSection = document.createElement('section');
    agentsSection.innerHTML = '<div class="section-title">Agents</div>';
    const agentsGrid = document.createElement('div');
    agentsGrid.className = 'agents-grid';

    const agentList = [
      { key: 'kikai', label: 'Kikai', pfp: './kikai-pfp.png' },
      { key: 'yama', label: 'Yama', pfp: './yama-pfp.png' },
    ];

    agentList.forEach(({ key, label, pfp }) => {
      const a = data.agents[key];
      if (!a) return;

      const ctx = a.contextPct || 0;
      const ctxClass = ctx >= 75 ? 'high' : ctx >= 50 ? 'mid' : 'low';
      const fuelClass = ctx >= 75 ? 'fuel-red' : ctx >= 50 ? 'fuel-yellow' : 'fuel-green';
      const statusClass = 'status-' + (a.status || 'unknown').replace('_', '-').replace(' ', '-');

      const card = document.createElement('div');
      card.className = 'agent-card' + (a.rateLimit ? ' rate-limited' : '');
      card.innerHTML = `
        <div class="agent-header">
          <div class="agent-identity">
            <img class="agent-avatar" src="${pfp}" alt="${label}">
            <div class="agent-name">${label}</div>
          </div>
          <span class="status-pill ${statusClass}">${a.status || 'unknown'}</span>
        </div>

        <div class="agent-field">
          <div class="field-label">Working on</div>
          <div class="field-value ${!a.workingOn || a.workingOn === 'idle' ? 'muted' : ''}">${escHtml(a.workingOn || 'idle')}</div>
        </div>

        <div class="agent-field">
          <div class="field-label">Context</div>
          <div class="context-row">
            <span class="context-pct ${ctxClass}">${ctx}%</span>
            <span class="field-label">${a.model || ''}</span>
          </div>
          <div class="fuel-gauge">
            <div class="fuel-fill ${fuelClass}" style="width:${ctx}%;"></div>
          </div>
        </div>

        ${a.sessionDurationMin != null ? `
        <div class="agent-field">
          <div class="field-label">Session</div>
          <div class="field-value">${a.sessionDurationMin}m duration${a.lastActivityMin != null ? ' / ' + a.lastActivityMin + 'm idle' : ''}</div>
        </div>` : ''}

        ${a.rateLimit ? '<div class="rate-limit-warning">Rate limited</div>' : ''}
      `;
      agentsGrid.appendChild(card);
    });

    agentsSection.appendChild(agentsGrid);
    main.appendChild(agentsSection);
  }

  // ── PROJECTS ──────────────────────────────────────────
  if (data.projects && data.projects.length > 0) {
    const projectsSection = document.createElement('section');
    projectsSection.innerHTML = '<div class="section-title">Projects</div>';
    const projectsGrid = document.createElement('div');
    projectsGrid.className = 'projects-grid';

    const sorted = [...data.projects].sort((a, b) => (a.priority || 99) - (b.priority || 99));

    sorted.forEach(proj => {
      const card = document.createElement('div');
      card.className = 'project-card';
      card.style.borderLeftColor = proj.color || 'var(--border2)';

      const statusStr = (proj.status || 'unknown').toLowerCase();
      let statusClass = statusStr;
      if (statusStr === 'active') statusClass = 'active';
      else if (statusStr === 'building') statusClass = 'building';
      else if (statusStr === 'paused') statusClass = 'paused';
      else if (statusStr === 'blocked') statusClass = 'blocked';
      else if (statusStr === 'queued') statusClass = 'queued';

      const tasks = proj.tasks || [];
      let tasksHtml = '';
      tasks.forEach(t => {
        const dotClass = 'dot-' + (t.status || 'queued');
        tasksHtml += `
          <div class="task-row">
            <div class="task-dot ${dotClass}"></div>
            <div class="task-text">
              <strong>${escHtml(t.title || 'Task')}</strong>
              ${t.lastUpdate ? ' — ' + escHtml(t.lastUpdate) : ''}
            </div>
          </div>
          ${t.nextAction ? '<div class="next-action">' + escHtml(t.nextAction) + '</div>' : ''}
        `;
      });

      const needs = proj.needsToDo || [];
      let needsHtml = '';
      needs.forEach(n => {
        const isUrgent = n.urgent ? ' urgent' : '';
        const dotClass = n.wjp ? 'wjp-dot' : 'agent-dot';
        needsHtml += `
          <div class="need-item${isUrgent}">
            <div class="need-dot ${dotClass}"></div>
            <span class="need-text ${n.wjp ? 'wjp' : ''}">${escHtml(n.text || '')}</span>
          </div>
        `;
      });

      card.innerHTML = `
        <div class="project-header">
          <div>
            <div class="project-name">${escHtml(proj.name)}</div>
            <div class="project-priority">Priority ${proj.priority || '—'}</div>
          </div>
          <span class="project-status ${statusClass}">${escHtml(proj.status || 'unknown')}</span>
        </div>
        <div class="project-desc">${escHtml(proj.description || '')}</div>
        ${tasksHtml || needs.length > 0 ? '<div class="project-divider"></div>' : ''}
        ${tasksHtml ? '<div class="project-task">' + tasksHtml + '</div>' : ''}
        ${needsHtml ? '<div class="project-needs">' + needsHtml + '</div>' : ''}
      `;

      projectsGrid.appendChild(card);
    });

    projectsSection.appendChild(projectsGrid);
    main.appendChild(projectsSection);
  }

  // ── INTEL ─────────────────────────────────────────────
  const intel = Array.isArray(data.intel) ? data.intel : [];
  if (intel.length > 0) {
    const intelSection = document.createElement('section');
    intelSection.innerHTML = '<div class="section-title">Intel</div>';
    const intelGrid = document.createElement('div');
    intelGrid.className = 'intel-section';
    intel.slice(0, 5).forEach(item => {
      const div = document.createElement('div');
      div.className = 'intel-item';
      div.textContent = item.text || String(item);
      intelGrid.appendChild(div);
    });
    intelSection.appendChild(intelGrid);
    main.appendChild(intelSection);
  }
}

// ════════════════════════════════════════════════════════
// ERROR
// ════════════════════════════════════════════════════════
function showError(url, msg) {
  const main = document.getElementById('main');
  main.innerHTML = `
    <div id="error-banner" class="visible">
      <div class="error-title">Failed to load mission data</div>
      <div class="error-url">${escHtml(url)}</div>
      <div style="font-size:17px;color:var(--text2);margin-top:4px;">${escHtml(msg)}</div>
      <button class="retry-btn" onclick="loadData()">Retry</button>
    </div>
  `;
}

// ════════════════════════════════════════════════════════
// UTIL
// ════════════════════════════════════════════════════════
function escHtml(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════
loadData();
</script>
</body>
</html>
